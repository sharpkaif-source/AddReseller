name: Test Email Only

on:
  workflow_dispatch:

jobs:
  test-email:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Test Email via Office API
        continue-on-error: true
        run: |
          echo "üß™ Testing Office API Email...\n"
          
          API_URL="${{ secrets.OFFICE_API_URL }}"
          API_KEY="${{ secrets.OFFICE_API_KEY }}"
          
          if [ -z "$API_URL" ]; then
            echo "‚ùå ERROR: OFFICE_API_URL secret is not set!"
            echo "   Please add it in: Settings ‚Üí Secrets and variables ‚Üí Actions"
            exit 1
          fi
          
          echo "üìß Configuration:"
          echo "   API URL: $API_URL"
          echo "   API Key: ${API_KEY:+‚úÖ Set (hidden)}${API_KEY:-‚ùå Not set}"
          echo ""
          
          # Prepare test email
          SUBJECT="üß™ Test Email from GitHub Actions"
          BODY="<h2>‚úÖ Office API Test Successful!</h2>
          <p>This is a test email to verify Office API configuration is working.</p>
          <p><strong>Time:</strong> ${{ github.run_id }}</p>
          <p><strong>Workflow:</strong> Test Email Only</p>
          <p>If you received this email, the Office API is working correctly!</p>
          <hr>
          <p><small>This is a test from GitHub Actions.</small></p>"
          
          TO="mohd.kashif@singleinterface.com"
          
          # Create JSON payload (adjust format based on your Office API requirements)
          JSON_PAYLOAD=$(jq -n \
            --arg to "$TO" \
            --arg subject "$SUBJECT" \
            --arg body "$BODY" \
            '{to: $to, subject: $subject, body: $body}')
          
          echo "üì§ Sending test email..."
          echo "   To: $TO"
          echo "   Subject: $SUBJECT"
          echo ""
          
          # Send HTTP request (adjust headers based on your API)
          HTTP_CODE=$(curl -X POST "$API_URL" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $API_KEY" \
            -d "$JSON_PAYLOAD" \
            -w "%{http_code}" \
            -o /tmp/api-response.txt \
            -s)
          
          echo "üì• Response:"
          cat /tmp/api-response.txt
          echo ""
          echo "HTTP Status: $HTTP_CODE"
          echo ""
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "‚úÖ Email sent successfully via Office API!"
            echo "üì¨ Check your inbox: $TO"
          else
            echo "‚ùå Failed to send email (HTTP $HTTP_CODE)"
            echo ""
            echo "üí° Troubleshooting:"
            echo "   1. Check if API URL is correct"
            echo "   2. Verify API key is valid"
            echo "   3. Check API documentation for correct format"
            echo "   4. Review the response above for error details"
            exit 1
          fi
