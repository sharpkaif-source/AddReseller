name: Test Email Only

on:
  workflow_dispatch:

jobs:
  test-email:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Test Email via SendGrid
        continue-on-error: true
        run: |
          echo "üß™ Testing SendGrid Email...\n"
          
          API_KEY="${{ secrets.SENDGRID_API_KEY }}"
          
          if [ -z "$API_KEY" ]; then
            echo "‚ùå ERROR: SENDGRID_API_KEY secret is not set!"
            echo "   Please add it in: Settings ‚Üí Secrets and variables ‚Üí Actions"
            exit 1
          fi
          
          echo "üìß Configuration:"
          echo "   API: SendGrid (https://api.sendgrid.com/v3/mail/send)"
          echo "   API Key: ${API_KEY:+‚úÖ Set (hidden)}${API_KEY:-‚ùå Not set}"
          echo ""
          
          # Prepare test email
          SUBJECT="üß™ Test Email from GitHub Actions"
          HTML_BODY="<h2>‚úÖ SendGrid Test Successful!</h2>
          <p>This is a test email to verify SendGrid configuration is working.</p>
          <p><strong>Time:</strong> ${{ github.run_id }}</p>
          <p><strong>Workflow:</strong> Test Email Only</p>
          <p>If you received this email, SendGrid is working correctly!</p>
          <hr>
          <p><small>This is a test from GitHub Actions.</small></p>"
          
          TO="mohd.kashif@singleinterface.com"
          
          # Create SendGrid JSON payload
          JSON_PAYLOAD=$(jq -n \
            --arg to "$TO" \
            --arg subject "$SUBJECT" \
            --arg body "$HTML_BODY" \
            '{
              "personalizations": [
                {
                  "to": [{"email": $to}]
                }
              ],
              "from": {
                "email": "mohd.kashif@singleinterface.com",
                "name": "SingleInterface"
              },
              "reply_to": {
                "email": "mohd.kashif@singleinterface.com",
                "name": "SingleInterface"
              },
              "subject": $subject,
              "content": [
                {
                  "type": "text/html",
                  "value": $body
                }
              ],
              "tracking_settings": {
                "click_tracking": {"enable": true, "enable_text": false},
                "open_tracking": {"enable": true, "substitution_tag": "%open-track%"},
                "subscription_tracking": {"enable": true}
              },
              "categories": ["reseller_bot", "test"]
            }')
          
          echo "üì§ Sending test email..."
          echo "   To: $TO"
          echo "   Subject: $SUBJECT"
          echo ""
          
          # Send HTTP request to SendGrid
          HTTP_CODE=$(curl -X POST "https://api.sendgrid.com/v3/mail/send" \
            -H "Authorization: Bearer $API_KEY" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            -w "%{http_code}" \
            -o /tmp/api-response.txt \
            -s)
          
          echo "üì• Response:"
          cat /tmp/api-response.txt
          echo ""
          echo "HTTP Status: $HTTP_CODE"
          echo ""
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "‚úÖ Email sent successfully via SendGrid!"
            echo "üì¨ Check your inbox: $TO"
          else
            echo "‚ùå Failed to send email (HTTP $HTTP_CODE)"
            echo ""
            echo "üí° Troubleshooting:"
            echo "   1. Check if SendGrid API key is correct"
            echo "   2. Verify API key has 'Mail Send' permissions"
            echo "   3. Check SendGrid account status"
            echo "   4. Review the response above for error details"
            exit 1
          fi
